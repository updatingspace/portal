name: CI and Publish

permissions:
  contents: read
  packages: write

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate-build-id:
    name: Generate BUILD_ID
    runs-on: ubuntu-latest
    outputs:
      build_id: ${{ steps.build_id.outputs.BUILD_ID }}
      short_sha: ${{ steps.build_id.outputs.SHORT_SHA }}
    steps:
      - name: Generate BUILD_ID
        id: build_id
        run: |
          BUILD_DATE=$(date -u +%Y.%m.%d)
          SHORT_SHA="${GITHUB_SHA::7}"
          BUILD_ID="${BUILD_DATE}-${GITHUB_RUN_NUMBER}-${SHORT_SHA}"
          echo "BUILD_ID=${BUILD_ID}" >> "$GITHUB_OUTPUT"
          echo "SHORT_SHA=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "Build ID: ${BUILD_ID}"

  python-services-check:
    name: Check Python service (${{ matrix.service }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: access
            test_target: src
          - service: activity
            test_target: src
          - service: bff
            test_target: src/bff/tests.py
          - service: events
            test_target: src/events/tests.py
          - service: gamification
            test_target: src/gamification/tests.py
          - service: portal
            test_target: src/portal/tests.py
          - service: voting
            test_target: >-
              src/core/tests/test_production_components.py
              src/nominations/test_services_unit.py
              src/tenant_voting/test_services_unit.py
              src/tenant_voting/tests.py
              src/tenant_voting/test_integration.py
    defaults:
      run:
        working-directory: services/${{ matrix.service }}
    env:
      DJANGO_SETTINGS_MODULE: app.settings
      PYTHONPATH: src
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e .
          pip install pytest pytest-django ruff
      - name: Run Ruff
        run: ruff check src
      - name: Run tests
        run: pytest -q ${{ matrix.test_target }}

  docker-build-validate:
    name: Build image (${{ matrix.image }})
    runs-on: ubuntu-latest
    needs:
      - python-services-check
      - generate-build-id
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: updatingspace-portal-access
            context: services/access
            dockerfile: services/access/Dockerfile
            build_args: ''
          - image: updatingspace-portal-activity
            context: services/activity
            dockerfile: services/activity/Dockerfile
            build_args: ''
          - image: updatingspace-portal-bff
            context: services/bff
            dockerfile: services/bff/Dockerfile
            build_args: ''
          - image: updatingspace-portal-events
            context: services/events
            dockerfile: services/events/Dockerfile
            build_args: ''
          - image: updatingspace-portal-gamification
            context: services/gamification
            dockerfile: services/gamification/Dockerfile
            build_args: ''
          - image: updatingspace-portal-portal
            context: services/portal
            dockerfile: services/portal/Dockerfile
            build_args: ''
          - image: updatingspace-portal-voting
            context: services/voting
            dockerfile: services/voting/Dockerfile
            build_args: ''
          - image: updatingspace-portal-frontend
            context: .
            dockerfile: web/portal-frontend/Dockerfile
            build_args: |
              VITE_BUILD_ID=${{ needs.generate-build-id.outputs.build_id }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build image (no push)
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: false
          build-args: ${{ matrix.build_args }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  publish-images:
    name: Publish image (${{ matrix.image }})
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    needs:
      - docker-build-validate
      - generate-build-id
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: updatingspace-portal-access
            context: services/access
            dockerfile: services/access/Dockerfile
            build_args: ''
          - image: updatingspace-portal-activity
            context: services/activity
            dockerfile: services/activity/Dockerfile
            build_args: ''
          - image: updatingspace-portal-bff
            context: services/bff
            dockerfile: services/bff/Dockerfile
            build_args: ''
          - image: updatingspace-portal-events
            context: services/events
            dockerfile: services/events/Dockerfile
            build_args: ''
          - image: updatingspace-portal-gamification
            context: services/gamification
            dockerfile: services/gamification/Dockerfile
            build_args: ''
          - image: updatingspace-portal-portal
            context: services/portal
            dockerfile: services/portal/Dockerfile
            build_args: ''
          - image: updatingspace-portal-voting
            context: services/voting
            dockerfile: services/voting/Dockerfile
            build_args: ''
          - image: updatingspace-portal-frontend
            context: .
            dockerfile: web/portal-frontend/Dockerfile
            build_args: |
              VITE_BUILD_ID=${{ needs.generate-build-id.outputs.build_id }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}:${{ needs.generate-build-id.outputs.build_id }}
            ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}:latest
          build-args: ${{ matrix.build_args }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
